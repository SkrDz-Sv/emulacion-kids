' Gambas class file

Public Sub _new()

End

Public $con As New Connection
Private resultados As Result
Private videok As String
Private home As String

Public Sub Form_Open()

  Dim grupo As String 
  Shell "id -g" To grupo
  Shell "mkdir ~/emulacion-kids/ ~/emulacion-kids/roms ~/emulacion-kids/videos"
  Shell "sudo chown -R root:" & Left$(grupo, 4) & " ~/emulacion-kids/videos ; sudo chmod -R 774 ~/emulacion-kids/videos"
  Settings["Info/roms"] = "~/emulacion-kids/roms/"

End


Public Sub btnConfig2_Click()

  Shell "sudo shutdown -hP now"
  Me.Close()

End

Public Sub btnConfig_Click()

  'Dim config As New FrmConfig
  'config.Show()
  Shell "gnome-terminal"
  
End

Public Sub btnAtari_Click()

  prepararLista()
  Conectar()
  mostrarResultados(1)

End

Public Sub mostrarResultados(emulador As Integer)
  
  resultados = $con.Exec("select * from roms where idemulador = " & emulador & " order by descripcion ")
  While resultados.Available
    lbRoms.Add(resultados["descripcion"])
    resultados.MoveNext
  Wend
  $con.Close()
  
End


Public Sub Conectar()
  
  $con = Connections["conex"]
  If $con = Null Then
    Message.Error("Error en conexión a BD")
    $con = Null
  Endif
  Try $con.Open()
  If Error Then
    Message.Error("Error en conexión a BD - " & Error.Text & " - " & Error.Code & " - " & Error.Where)
  Endif
End

Public Sub prepararLista()
  
  If videok = 1 Then
    fcVideos.Visible = True
  Else
    lbRoms.Clear
    lbRoms.Visible = True
  Endif
  btnCancelar.Visible = True
  btnAtari.Visible = False
  btnNes.Visible = False
  btnSnes.Visible = False
  btnN64.Visible = False
  
End


Public Sub btnCancelar_Click()

  If videok = 1 Then
    fcVideos.Visible = False
    videok = 0
  Else
    lbRoms.Visible = False
  Endif
  btnCancelar.Visible = False
  btnAtari.Visible = True
  btnNes.Visible = True
  btnSnes.Visible = True
  btnN64.Visible = True

End


Public Sub lbRoms_Activate()

  Dim seleccionado As String 
  Dim nombre As Result
  seleccionado = lbRoms.Current.Text
  Conectar()
  nombre = $con.Exec("select idemulador,nombre from roms where descripcion = '" & seleccionado & "'")
  'Message.Info(nombre["nombre"])
  If nombre["idemulador"] == 1 Then
    Shell "stella -fullscreen 1 -fulres auto " & Settings["Info/roms"] & nombre["nombre"]
  Else If nombre["idemulador"] == 2 Then
    Shell "fceux --nogui 0 -f 1 --openglip 1 " & Settings["Info/roms"] & nombre["nombre"]
  Else If nombre["idemulador"] == 3 Then
    Shell "zsnes -1 1 -m -v 11 -y " & Settings["Info/roms"] & nombre["nombre"]
  Else If nombre["idemulador"] == 4 Then
    Shell "/usr/games/mupen64plus --fullscreen " & Settings["Info/roms"] & nombre["nombre"]
  Endif
  btnCancelar_Click()
  $con.Close()

End

Public Sub btnNes_Click()

  prepararLista()
  Conectar()
  mostrarResultados(2)

End

Public Sub btnSnes_Click()

  prepararLista()
  Conectar()
  mostrarResultados(3)

End

Public Sub btnN64_Click()

  prepararLista()
  Conectar()
  mostrarResultados(4)

End

Public Sub lbRoms_DblClick()

  Dim seleccionado As String 
  Dim nombre As Result
  seleccionado = lbRoms.Current.Text
  Conectar()
  nombre = $con.Exec("select idemulador,nombre from roms where descripcion = '" & seleccionado & "'")
  'Message.Info(nombre["nombre"])
  If nombre["idemulador"] == 1 Then
    Shell "stella -fullscreen 1 -fulres auto " & Settings["Info/roms"] & nombre["nombre"]
  Else If nombre["idemulador"] == 2 Then
    Shell "fceux --nogui 0 -f 1 --openglip 1 " & Settings["Info/roms"] & nombre["nombre"]
  Else If nombre["idemulador"] == 3 Then
    Shell "zsnes -1 1 -m -v 11 -y " & Settings["Info/roms"] & nombre["nombre"]
  Else If nombre["idemulador"] == 4 Then
    Shell "/usr/games/mupen64plus --fullscreen " & Settings["Info/roms"] & nombre["nombre"]
  Endif
  btnCancelar_Click()
  $con.Close()  

End

Public Sub lbRoms_Click()

  

End

Public Sub btnReparar_Click()

  Shell "xrandr --output VGA-0 --mode 1024x768"

End

Public Sub btnVideo_Click()

  Shell "echo ~" To home
  home = Left$(home, Len(home) - 1)
  'Print home
  fcVideos.Root = home & "/emulacion-kids/videos"
  videok = 1
  prepararLista()

End


Public Sub fcVideos_Change()

  Dim seleccionado As String 
  seleccionado = fcVideos.SelectedPath
  'Print seleccionado
  If seleccionado <> "" Then
    Shell "TERM=xterm sudo mplayer -fs \"" & seleccionado & "\""
    Print "TERM=xterm sudo mplayer -fs \"" & seleccionado & "\""
    'finvideo()
  Endif

End

